<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Residual analysis for community detection • scrooge</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">scrooge</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/communities.html">Fitting log-linear models to players in communities</a>
    </li>
    <li>
      <a href="../articles/profiles.html">Journal and community profiles</a>
    </li>
    <li>
      <a href="../articles/quasisymmetry.html">Quasi-symmetry models with the `scrooge` package</a>
    </li>
    <li>
      <a href="../articles/residuals.html">Residual analysis for community detection</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Selbosh/scrooge">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Residual analysis for community detection</h1>
                        <h4 class="author">David Selby</h4>
            
            <h4 class="date">30 September 2017</h4>
          </div>

    
    
<div class="contents">
<p>The <strong>scrooge</strong> package offers several utilities for diagnosing the output of community detection algorithms.</p>
<p>Consider this canonical example from Varin et al. (2016). We have data describing the number of citations exchanged between 47 statistical journals. Access it using <code>data(citations)</code>.</p>
<p>A standard hierarchical clustering of the data yields eight communities.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(scrooge)
distances &lt;-<span class="st"> </span><span class="kw">as.dist</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">cor</span>(citations <span class="op">+</span><span class="st"> </span><span class="kw">t</span>(citations) <span class="op">-</span><span class="st"> </span><span class="kw">diag</span>(<span class="kw">diag</span>(citations))))
clusters &lt;-<span class="st"> </span><span class="kw">cutree</span>(<span class="kw">hclust</span>(distances), <span class="dt">h =</span> <span class="fl">0.6</span>)</code></pre></div>
<ol style="list-style-type: decimal">
<li>AmS, ISR</li>
<li>AISM, ANZS, CSTM, JSPI, JTSA, Mtka, Stats, StPap, SPL</li>
<li>AoS, Bern, Bka, CJS, JASA, JCGS, JMA, JNS, JRSS-B, SJS, StCmp, StNee, StSin, Test</li>
<li>BioJ, Bcs, Biost, JBS, JRSS-A, JRSS-C, LDA, StMed, SMMR, StMod, StSci</li>
<li>CSSC, CmpSt, CSDA, JAS, JSCS, Tech</li>
<li>EES, Envr, JABES</li>
<li>JSS</li>
<li>StataJ</li>
</ol>
<p>An ‘expert’ review of these clusters may confirm that they look sensible, but that’s not good enough for us. We want a <em>quantitative</em> diagnosis of their descriptive and predictive power.</p>
<p>Consider, for example, the journal <em>Biometrika</em>, which falls in the third cluster. Is the citation behaviour of this publication described adequately by the community to which it has been assigned?</p>
<div id="citation-profiles" class="section level2">
<h2 class="hasAnchor">
<a href="#citation-profiles" class="anchor"></a>Citation profiles</h2>
<p>Every journal has a <em>citation profile</em>, which is a stochastic vector representing the distribution of that journal’s outgoing citations. It is the transition probability vector that describes one step of a random walk around the graph.</p>
<p>For example, suppose we have three journals, <span class="math inline">\(A\)</span>, <span class="math inline">\(B\)</span> and <span class="math inline">\(C\)</span>. If half of the references in journal <span class="math inline">\(C\)</span>’s bibliography were to journal <span class="math inline">\(A\)</span>, a quarter to <span class="math inline">\(B\)</span> and the remainder to itself, then journal <span class="math inline">\(C\)</span>’s citation profile would be given by the vector <span class="math inline">\(\pmatrix{0.5 &amp; 0.25 &amp; 0.25}\)</span>.</p>
<p>Communities also have citation profiles, calculated from the citations of their constituent journals. How these citations are aggregated is up to you—for now we settle for an unweighted sum, scaled to form a unit vector.</p>
<p>The eight communities in the statistical journals network each have a profile that lies somewhere on the part of the surface of the unit <span class="math inline">\(46\)</span>-sphere in the positive orthant of <span class="math inline">\(\mathbb{R}^{47}\)</span>.</p>
</div>
<div id="convex-combinations-of-community-profiles" class="section level2">
<h2 class="hasAnchor">
<a href="#convex-combinations-of-community-profiles" class="anchor"></a>Convex combinations of community profiles</h2>
<p>However our clustering or community detection algorithm works, we have a grouping of journals into clusters. Unless they are really homogeneous, this reduction in dimensionality throws away some detail of each journal’s citation behaviour.</p>
<p>How well do the eight clusters describe <em>Biometrika</em>’s citation profile?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Biometrika_profile &lt;-<span class="st"> </span>citations[, <span class="st">'Bka'</span>] <span class="op">/</span><span class="st"> </span><span class="kw">colSums</span>(citations)[<span class="st">'Bka'</span>]
np &lt;-<span class="st"> </span><span class="kw"><a href="../reference/nearest_point.html">nearest_point</a></span>(<span class="st">'Bka'</span>, citations, clusters)
near_Biometrika &lt;-<span class="st"> </span><span class="kw"><a href="../reference/community_profile.html">community_profile</a></span>(citations, clusters) <span class="op">%*%</span><span class="st"> </span>np<span class="op">$</span>solution
<span class="kw"><a href="../reference/dissimilarity.html">dissimilarity</a></span>(Biometrika_profile, near_Biometrika)</code></pre></div>
<pre><code>## [1] 0.1616911</code></pre>
<p>Using the index of dissimilarity, we see that 16% of citations are misallocated, when comparing <em>Biometrika</em>’s profile to the nearest possible combination of the eight community profiles.</p>
<p>We can also compute Poisson residuals on the citation counts.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Bka_predicted &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitted_citations.html">fitted_citations</a></span>(<span class="st">'Bka'</span>, citations, clusters)
Bka_residuals &lt;-<span class="st"> </span><span class="kw"><a href="../reference/profile_residuals.html">profile_residuals</a></span>(Bka_predicted, citations[, <span class="st">'Bka'</span>])</code></pre></div>
<p>Do the functions from the <strong>scrooge</strong> package calculate the residuals correctly? Recall the formula for Poisson residuals is <span class="math display">\[
r_i = \frac{y_i - \hat{y}_i}{\sqrt{\hat{y}_i}}.
\]</span></p>
<p>The binary operator <code>%==%</code> allows us to check if two vectors are equal (whilst allowing for floating-point error).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Bka_residuals <span class="op">%==%</span><span class="st"> </span>((citations[, <span class="st">'Bka'</span>] <span class="op">-</span><span class="st"> </span>Bka_predicted) <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(Bka_predicted))</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>How might we calculate this using a (null) <code>glm</code>?</p>
<p>Remember, a Poisson regression takes the form <span class="math display">\[
\log\mathbb{E[y]} = \mathbf{X}\boldsymbol\beta,
\]</span> so we will need to take logs whenever referring to predictors that are on the same scale as responses.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model &lt;-<span class="st"> </span><span class="kw">glm</span>(citations[, <span class="st">'Bka'</span>] <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span><span class="kw">offset</span>(<span class="kw">log</span>(Bka_predicted)), <span class="dt">family =</span> <span class="st">'poisson'</span>)
Bka_residuals <span class="op">%==%</span><span class="st"> </span><span class="kw">resid</span>(model, <span class="dt">type =</span> <span class="st">'pearson'</span>)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Now that we have calculated some model residuals, we can plot them in the usual way.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(dplyr))
<span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(ggplot2))
<span class="kw">theme_set</span>(<span class="kw">theme_bw</span>())

resids_df &lt;-<span class="st"> </span><span class="kw">data_frame</span>(<span class="dt">journal =</span> <span class="kw">rownames</span>(Bka_residuals),
                        <span class="dt">residual =</span> <span class="kw">drop</span>(Bka_residuals),
                        <span class="dt">fitted =</span> <span class="kw">drop</span>(Bka_predicted),
                        <span class="dt">q_theo =</span> <span class="kw">qqnorm</span>(residual, <span class="dt">plot =</span> F)<span class="op">$</span>x)

<span class="kw">ggplot</span>(resids_df) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(fitted, residual, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">colour =</span> <span class="st">'steelblue'</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">'loess'</span>, <span class="dt">colour =</span> <span class="st">'steelblue'</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> journal <span class="op">==</span><span class="st"> 'Bka'</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Predicted citation counts'</span>, <span class="dt">y =</span> <span class="st">'Residuals'</span>,
       <span class="dt">title =</span> <span class="st">"Profile residuals for 'Biometrika'"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">'black'</span>, <span class="st">'tomato2'</span>), <span class="dt">guide =</span> <span class="st">'none'</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/residual_plots-1.png" width="576"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(resids_df) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(q_theo, residual, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> journal <span class="op">==</span><span class="st"> 'Bka'</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggqqline</span>(Bka_residuals) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Normal quantiles'</span>,
       <span class="dt">y =</span> <span class="st">'Sample quantiles'</span>,
       <span class="dt">title =</span> <span class="st">"Profile residuals for 'Biometrika'"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">'black'</span>, <span class="st">'tomato2'</span>), <span class="dt">guide =</span> <span class="st">'none'</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/residual_plots-2.png" width="576"></p>
</div>
<div id="controlling-for-excessive-self-citation-behaviour" class="section level2">
<h2 class="hasAnchor">
<a href="#controlling-for-excessive-self-citation-behaviour" class="anchor"></a>Controlling for excessive self-citation behaviour</h2>
<p>Notice how <em>Biometrika</em> has an extremely high profile residual for citing <em>itself</em>. In other words, the clustering model is under-predicting self-citations. To account for the possibility of ‘excess’ self-citations, we can add a term to the Poisson regression model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Bka_selfcites &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">rownames</span>(citations) <span class="op">==</span><span class="st"> 'Bka'</span>)
<span class="co"># Bka_selfcites2 &lt;- diag(diag(citations))[, rownames(citations) == 'Bka'] # actual count</span>
Bka_selfcite_model &lt;-<span class="st"> </span><span class="kw">update</span>(model, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span>Bka_selfcites)
broom<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/tidy">tidy</a></span>(Bka_selfcite_model)</code></pre></div>
<pre><code>##            term  estimate std.error statistic      p.value
## 1 Bka_selfcites 0.6901858   0.11547  5.977187 2.270234e-09</code></pre>
<p>What do the residuals look like now?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">resids_self_df &lt;-<span class="st"> </span><span class="kw">data_frame</span>(<span class="dt">journal =</span> <span class="kw">rownames</span>(citations),
                             <span class="dt">residual =</span> <span class="kw">resid</span>(Bka_selfcite_model, <span class="dt">type =</span> <span class="st">'pearson'</span>),
                             <span class="dt">fitted =</span> <span class="kw">fitted</span>(Bka_selfcite_model),
                             <span class="dt">q_theo =</span> <span class="kw">qqnorm</span>(residual, <span class="dt">plot =</span> F)<span class="op">$</span>x)

<span class="kw">ggplot</span>(resids_self_df) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(fitted, residual, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">colour =</span> <span class="st">'steelblue'</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">'loess'</span>, <span class="dt">colour =</span> <span class="st">'steelblue'</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> journal <span class="op">==</span><span class="st"> 'Bka'</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Predicted citation counts'</span>, <span class="dt">y =</span> <span class="st">'Residuals'</span>,
       <span class="dt">title =</span> <span class="st">"Profile residuals for 'Biometrika'"</span>,
       <span class="dt">subtitle =</span> <span class="st">'Controlling for excessive self-citation'</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">'black'</span>, <span class="st">'tomato2'</span>), <span class="dt">guide =</span> <span class="st">'none'</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/self_citation_residuals-1.png" width="576"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(resids_self_df) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(q_theo, residual, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> journal <span class="op">==</span><span class="st"> 'Bka'</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggqqline</span>(Bka_residuals) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Normal quantiles'</span>,
       <span class="dt">y =</span> <span class="st">'Sample quantiles'</span>,
       <span class="dt">title =</span> <span class="st">"Profile residuals for 'Biometrika'"</span>,
       <span class="dt">subtitle =</span> <span class="st">'Controlling for excessive self-citation'</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">'black'</span>, <span class="st">'tomato2'</span>), <span class="dt">guide =</span> <span class="st">'none'</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/self_citation_residuals-2.png" width="576"></p>
<p>What can explain the departure of the top 9 or so journals from the Q–Q line? Could it simply be the mismatch between the Poisson distribution and its Normal approximation? Recall that a Poisson distribution may be approximated with Normal when <span class="math inline">\(\lambda\)</span> is large. Some journals’ citation rates are larger than others!</p>
<p>The top 10 residuals for the <em>Biometrika</em> model are</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">resids_self_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(residual)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(journal, residual) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, residual)</code></pre></div>
<pre><code>## # A tibble: 10 x 2
##    journal      residual
##      &lt;chr&gt;         &lt;dbl&gt;
##  1     LDA  2.556214e+00
##  2   Biost  2.047477e+00
##  3   StSin  1.899348e+00
##  4  JRSS-C  1.587074e+00
##  5    BioJ  1.354679e+00
##  6   StSci  1.301029e+00
##  7    JASA  1.018278e+00
##  8     Bcs  8.960843e-01
##  9     SJS  6.656752e-01
## 10     Bka -3.413131e-12</code></pre>
<p>Which journals are cited by Biometrika—or Biometrika’s community—least?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">near_Biometrika <span class="op">%&gt;%</span>
<span class="st">  </span>as.matrix <span class="op">%&gt;%</span><span class="st"> </span>as.data.frame <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">journal =</span> <span class="kw">rownames</span>(near_Biometrika)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">profile =</span> <span class="st">'V1'</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(profile)</code></pre></div>
<pre><code>##         profile journal
## 1  0.0006609707  StataJ
## 2  0.0010242470   StPap
## 3  0.0017319563     JAS
## 4  0.0024298233   JABES
## 5  0.0024454028     EES
## 6  0.0026487784    CSSC
## 7  0.0027307814     ISR
## 8  0.0031334273   StNee
## 9  0.0035926543    JTSA
## 10 0.0036672883   StMod
## 11 0.0041363576     JSS
## 12 0.0043315227   CmpSt
## 13 0.0044487900   Stats
## 14 0.0044578422    SMMR
## 15 0.0044742120    Mtka
## 16 0.0044742120    ANZS
## 17 0.0047186405     JBS
## 18 0.0051548675     AmS
## 19 0.0053246106    JSCS
## 20 0.0055345649     LDA
## 21 0.0061233751  JRSS-A
## 22 0.0069548791    Envr
## 23 0.0074239485    CSTM
## 24 0.0077823293  JRSS-C
## 25 0.0084695636    BioJ
## 26 0.0090755337    Test
## 27 0.0091616419    Tech
## 28 0.0098045597    AISM
## 29 0.0111141852     JNS
## 30 0.0126411341   StCmp
## 31 0.0153325459     CJS
## 32 0.0178592129   Biost
## 33 0.0182322801   StSci
## 34 0.0199609214    Bern
## 35 0.0217092989     SJS
## 36 0.0234600984     SPL
## 37 0.0247935141    JCGS
## 38 0.0327824826   StSin
## 39 0.0347530789    CSDA
## 40 0.0362381847    JSPI
## 41 0.0447547440   StMed
## 42 0.0482724557     JMA
## 43 0.0530043565     Bcs
## 44 0.0755245301     Bka
## 45 0.0824047752  JRSS-B
## 46 0.1395789676    JASA
## 47 0.1516664531     AoS</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">citations[, <span class="st">'Bka'</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>as.data.frame <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">citations =</span> <span class="st">'.'</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">journal =</span> <span class="kw">rownames</span>(scrooge<span class="op">::</span>citations)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(citations <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(citations) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">head</span>(<span class="dt">n =</span> <span class="dv">10</span>)</code></pre></div>
<pre><code>##    citations journal
## 1          1     AmS
## 2          1   CmpSt
## 3          1    Envr
## 4          1     JNS
## 5          1    JSCS
## 6          2    ANZS
## 7          2  JRSS-A
## 8          2     JSS
## 9          2    Mtka
## 10         2   Stats</code></pre>
<p>Nothing much there, it seems.</p>
</div>
<div id="community-residuals" class="section level2">
<h2 class="hasAnchor">
<a href="#community-residuals" class="anchor"></a>Community residuals</h2>
<p>Using the <code><a href="../reference/community_residuals.html">community_residuals()</a></code> function from the <strong>scrooge</strong> package, we can calculate the residual sum of squares for each journal based on a given community structure.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">community_resids &lt;-<span class="st"> </span><span class="kw">data_frame</span>(<span class="dt">journal =</span> <span class="kw">rownames</span>(citations),
                               <span class="dt">articles =</span> <span class="kw">drop</span>(scrooge<span class="op">::</span>articles),
                               <span class="dt">residual =</span> <span class="kw"><a href="../reference/community_residuals.html">community_residuals</a></span>(citations, clusters),
                               <span class="dt">outcitations =</span> <span class="kw">colSums</span>(citations),
                               <span class="dt">q_norm =</span> <span class="kw">qqnorm</span>(residual, <span class="dt">plot =</span> F)<span class="op">$</span>x,
                               <span class="dt">q_chi =</span> <span class="kw">qchisq</span>(<span class="kw">ppoints</span>(<span class="kw">nrow</span>(citations))[<span class="kw">order</span>(<span class="kw">order</span>(residual))], <span class="dt">df =</span> <span class="kw">nrow</span>(citations)))

<span class="kw">ggplot</span>(community_resids) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(outcitations, residual, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">'loess'</span>, <span class="dt">se =</span> F) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Outgoing citations'</span>, <span class="dt">y =</span> <span class="st">'Profile residual sum of squares'</span>,
       <span class="dt">title =</span> <span class="st">'Community residuals against outgoing citation count'</span>)</code></pre></div>
<pre><code>## Warning: Removed 7 rows containing non-finite values (stat_smooth).</code></pre>
<pre><code>## Warning: Removed 7 rows containing missing values (geom_text).</code></pre>
<p><img src="residuals_files/figure-html/community_residuals-1.png" width="576"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(community_resids) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(articles, residual, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">'loess'</span>, <span class="dt">se =</span> F) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Number of articles'</span>, <span class="dt">y =</span> <span class="st">'Profile residual sum of squares'</span>,
       <span class="dt">title =</span> <span class="st">'Community residuals against journal size'</span>)</code></pre></div>
<pre><code>## Warning: Removed 7 rows containing non-finite values (stat_smooth).

## Warning: Removed 7 rows containing missing values (geom_text).</code></pre>
<p><img src="residuals_files/figure-html/community_residuals-2.png" width="576"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(community_resids) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(q_norm, residual, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">ggqqline</span>(community_resids<span class="op">$</span>residual) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Normal quantiles'</span>, <span class="dt">y =</span> <span class="st">'Sample quantiles'</span>,
       <span class="dt">title =</span> <span class="st">'QQ plot for community residuals (profile residual sum of squares)'</span>)</code></pre></div>
<pre><code>## Warning: Removed 7 rows containing missing values (geom_text).</code></pre>
<p><img src="residuals_files/figure-html/community_residuals-3.png" width="576"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(community_resids) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(q_chi, residual, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">ggqqline</span>(community_resids<span class="op">$</span>residual, <span class="dt">distribution =</span> qchisq, <span class="dt">df =</span> <span class="kw">nrow</span>(citations)) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Chi-squared quantiles'</span>, <span class="dt">y =</span> <span class="st">'Sample quantiles'</span>,
       <span class="dt">title =</span> <span class="st">'QQ plot for community residuals (profile residual sum of squares)'</span>)</code></pre></div>
<pre><code>## Warning: Removed 7 rows containing missing values (geom_text).</code></pre>
<p><img src="residuals_files/figure-html/community_residuals-4.png" width="576"></p>
<p>Again, we may want to control for self-citation rates.</p>
</div>
<div id="community-residuals-controlling-for-self-citation" class="section level2">
<h2 class="hasAnchor">
<a href="#community-residuals-controlling-for-self-citation" class="anchor"></a>Community residuals controlling for self-citation</h2>
<p>Is there a scalable way of doing this without a loop fitting lots of glms? Yes: we can take advantage of the <strong>broom</strong> package and use it with <strong>dplyr</strong>.</p>
<p>We want residual sum of squares for each model, where each model is either</p>
<ul>
<li>regressing actual citations on community averages</li>
<li>regression on community averages, plus a component for (excess) self-citation.</li>
</ul>
<p>Compare the null glm with the calculations currently built into the <strong>scrooge</strong> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hat_citations &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitted_citations.html">fitted_citations</a></span>(<span class="ot">NULL</span>, citations, clusters)
community_glm &lt;-<span class="st"> </span><span class="kw">glm</span>(<span class="kw">c</span>(citations) <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span><span class="kw">offset</span>(<span class="kw">log</span>(<span class="kw">c</span>(hat_citations))), <span class="dt">family =</span> poisson)
community_glm_resids &lt;-<span class="st"> </span><span class="kw">resid</span>(community_glm, <span class="dt">type =</span> <span class="st">'pearson'</span>)
community_scrooge_resids &lt;-<span class="st"> </span><span class="kw"><a href="../reference/profile_residuals.html">profile_residuals</a></span>(hat_citations, citations)

<span class="kw">plot</span>(<span class="kw">c</span>(community_scrooge_resids), community_glm_resids, <span class="dt">xlab =</span> <span class="st">'Scrooge package'</span>, <span class="dt">ylab =</span> <span class="st">'Null GLM'</span>)
<span class="kw">abline</span>(<span class="dt">a =</span> <span class="dv">0</span>, <span class="dt">b =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/community_selfcites-1.png" width="576"></p>
<p>Now we want a glm with self-citation terms added. Since the (log) predicted citations are all ‘offsets’, the design matrix is simply an identity matrix, with one term for each self-citation interaction. When we already known the design matrix, we can use the function <code>glm.fit</code> rather than <code>glm</code>, as follows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">get_rss &lt;-<span class="st"> </span><span class="cf">function</span>(j, <span class="dt">self_excess =</span> <span class="ot">TRUE</span>) {
  expected &lt;-<span class="st"> </span><span class="kw">log</span>(<span class="kw"><a href="../reference/fitted_citations.html">fitted_citations</a></span>(j, citations, clusters))
  expected[<span class="op">!</span><span class="kw">is.finite</span>(expected)] &lt;-<span class="st"> </span><span class="ot">NA</span>
  excess_self &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">rownames</span>(citations) <span class="op">==</span><span class="st"> </span>j)
  mod &lt;-<span class="st"> </span><span class="kw">glm</span>(citations[, j] <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>excess_self, <span class="dt">offset =</span> expected, <span class="dt">family =</span> poisson, <span class="dt">na.action =</span> na.omit)
  <span class="cf">if</span> (<span class="op">!</span>self_excess) mod &lt;-<span class="st"> </span><span class="kw">update</span>(mod, . <span class="op">~</span><span class="st"> </span>. <span class="op">-</span><span class="st"> </span>excess_self)
  <span class="kw">sum</span>(<span class="kw">resid</span>(mod, <span class="dt">type =</span> <span class="st">'pearson'</span>)<span class="op">^</span><span class="dv">2</span>)
}

community_rss &lt;-<span class="st"> </span><span class="kw">vapply</span>(<span class="kw">colnames</span>(citations), get_rss, <span class="kw">numeric</span>(<span class="dv">1</span>))</code></pre></div>
<pre><code>## Warning: glm.fit: fitted rates numerically 0 occurred

## Warning: glm.fit: fitted rates numerically 0 occurred

## Warning: glm.fit: fitted rates numerically 0 occurred

## Warning: glm.fit: fitted rates numerically 0 occurred</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">community_rss2 &lt;-<span class="st"> </span><span class="kw">vapply</span>(<span class="kw">colnames</span>(citations), get_rss, <span class="kw">numeric</span>(<span class="dv">1</span>), <span class="dt">self_excess =</span> <span class="ot">FALSE</span>)</code></pre></div>
<pre><code>## Warning: glm.fit: fitted rates numerically 0 occurred

## Warning: glm.fit: fitted rates numerically 0 occurred

## Warning: glm.fit: fitted rates numerically 0 occurred

## Warning: glm.fit: fitted rates numerically 0 occurred</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(community_rss, community_rss2, <span class="dt">type =</span> <span class="st">'n'</span>,
     <span class="dt">xlab =</span> <span class="st">'Accounting for self-citations'</span>, <span class="dt">ylab =</span> <span class="st">'Community averages only'</span>)
<span class="kw">text</span>(community_rss, community_rss2, <span class="dt">labels =</span> <span class="kw">rownames</span>(citations))</code></pre></div>
<p><img src="residuals_files/figure-html/glm_fit-1.png" width="576"></p>
</div>
<div id="tidy-profile-models" class="section level2">
<h2 class="hasAnchor">
<a href="#tidy-profile-models" class="anchor"></a>Tidy profile models</h2>
<p>Rather than do everything <em>ad hoc</em>, we will, as much as possible, take advantage of <code>glm</code>s and the <strong>broom</strong> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">njournals &lt;-<span class="st"> </span><span class="kw">ncol</span>(citations)
nearest_profiles &lt;-<span class="st"> </span><span class="kw">vapply</span>(<span class="kw">colnames</span>(citations), nearest_profile, <span class="kw">numeric</span>(njournals),
                           <span class="dt">citations =</span> citations, <span class="dt">communities =</span> clusters)

models &lt;-<span class="st"> </span>nearest_profiles <span class="op">%&gt;%</span>
<span class="st">  </span>as_data_frame <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">to =</span> <span class="kw">rownames</span>(citations)) <span class="op">%&gt;%</span>
<span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/gather">gather</a></span>(<span class="st">'from'</span>, <span class="st">'profile'</span>, <span class="op">-</span>to) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">citations =</span> citations[<span class="kw">cbind</span>(to, from)],
         <span class="dt">expected =</span> profile <span class="op">*</span><span class="st"> </span><span class="kw">colSums</span>(scrooge<span class="op">::</span>citations)[from],
         <span class="dt">logexpected =</span> <span class="kw">suppressWarnings</span>(<span class="kw">log</span>(expected))
         , <span class="dt">logexpected =</span> <span class="kw">replace</span>(logexpected, <span class="op">!</span><span class="kw">is.finite</span>(logexpected), <span class="ot">NA</span>)
         ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(from) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">self_citation =</span> <span class="kw">as.numeric</span>(to <span class="op">==</span><span class="st"> </span>from)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">do</span>(<span class="dt">xs_selfcitations =</span> <span class="kw">glm</span>(citations <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>self_citation, <span class="dt">family =</span> poisson,
                            <span class="dt">offset =</span> logexpected, <span class="dt">na.action =</span> na.omit, <span class="dt">data =</span> .),
     <span class="dt">null_model =</span> <span class="kw">glm</span>(citations <span class="op">~</span><span class="st"> </span><span class="dv">0</span>, <span class="dt">family =</span> poisson,
                      <span class="dt">offset =</span> logexpected, <span class="dt">na.action =</span> na.omit, <span class="dt">data =</span> .))</code></pre></div>
<pre><code>## Warning: glm.fit: fitted rates numerically 0 occurred

## Warning: glm.fit: fitted rates numerically 0 occurred

## Warning: glm.fit: fitted rates numerically 0 occurred

## Warning: glm.fit: fitted rates numerically 0 occurred</code></pre>
<p>Having fit each model, we can compute their residuals sums of squares with and without controlling for self-citation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">models_RSS &lt;-<span class="st"> </span>models <span class="op">%&gt;%</span>
<span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/gather">gather</a></span>(<span class="st">'model_type'</span>, <span class="st">'model'</span>, xs_selfcitations<span class="op">:</span>null_model) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span>
<span class="st">  </span>broom<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/augment">augment</a></span>(model, <span class="dt">type.residuals =</span> <span class="st">'pearson'</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(from, model_type) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">RSS =</span> <span class="kw">sum</span>(.resid<span class="op">^</span><span class="dv">2</span>))</code></pre></div>
<pre><code>## Warning in sqrt(deviance(model)/df.residual(model)): NaNs produced

## Warning in sqrt(deviance(model)/df.residual(model)): NaNs produced

## Warning in sqrt(deviance(model)/df.residual(model)): NaNs produced

## Warning in sqrt(deviance(model)/df.residual(model)): NaNs produced

## Warning in sqrt(deviance(model)/df.residual(model)): NaNs produced

## Warning in sqrt(deviance(model)/df.residual(model)): NaNs produced</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">models_RSS <span class="op">%&gt;%</span>
<span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/spread">spread</a></span>(model_type, RSS) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> null_model, <span class="dt">x =</span> xs_selfcitations, <span class="dt">label =</span> from)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_text</span>() <span class="op">+</span>
<span class="st">    </span><span class="co">#scale_x_log10() + scale_y_log10() +</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">'RSS from community averages'</span>,
         <span class="dt">x =</span> <span class="st">'RSS controlling for excessive self-citation'</span>,
         <span class="dt">title =</span> <span class="st">'Comparison of residual sum of squares from two community citation models'</span>,
         <span class="dt">subtitle =</span> <span class="st">'On a log-log scale'</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/modelRSS-1.png" width="576"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">models_RSS <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">reference_count =</span> <span class="kw">colSums</span>(citations)[from]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(reference_count, RSS,
             <span class="dt">colour =</span> model_type,
             <span class="dt">group =</span> model_type,
             <span class="dt">label =</span> from)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_text</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Number of outgoing references'</span>,
         <span class="dt">title =</span> <span class="st">'Residual sum of squares against reference count'</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">'bottom'</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/modelRSS-2.png" width="576"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">models_RSS <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">article_count =</span> scrooge<span class="op">::</span>articles[from, ]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(article_count, RSS,
             <span class="dt">colour =</span> model_type,
             <span class="dt">group =</span> model_type,
             <span class="dt">label =</span> from)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_text</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Number of articles'</span>,
         <span class="dt">title =</span> <span class="st">'Residual sum of squares against article count'</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">'bottom'</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/modelRSS-3.png" width="576"></p>
</div>
<div id="further-investigations" class="section level1">
<h1 class="hasAnchor">
<a href="#further-investigations" class="anchor"></a>Further investigations</h1>
<p>Community residuals seem very high for <em>Journal of the Royal Statistical Society: Series A</em> (JRSS-A) and <em>Technometrics</em> (Tech)—at least when not accounting for excess self-citation. What could be going on here? Let’s look at their profile residuals.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">resids_jrssa &lt;-<span class="st"> </span><span class="kw">data_frame</span>(<span class="dt">journal =</span> <span class="kw">rownames</span>(citations),
                           <span class="dt">fitted =</span> <span class="kw">drop</span>(<span class="kw"><a href="../reference/fitted_citations.html">fitted_citations</a></span>(<span class="st">'JRSS-A'</span>, citations, clusters)),
                           <span class="dt">residual =</span> <span class="kw"><a href="../reference/profile_residuals.html">profile_residuals</a></span>(fitted, citations[, <span class="st">'JRSS-A'</span>]),
                           <span class="dt">q_theo =</span> <span class="kw">qqnorm</span>(residual, <span class="dt">plot =</span> F)<span class="op">$</span>x)

<span class="kw">ggplot</span>(resids_jrssa) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(fitted, residual, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">colour =</span> <span class="st">'steelblue'</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">'loess'</span>, <span class="dt">colour =</span> <span class="st">'steelblue'</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> journal <span class="op">==</span><span class="st"> 'JRSS-A'</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Predicted citation counts'</span>, <span class="dt">y =</span> <span class="st">'Residuals'</span>,
       <span class="dt">title =</span> <span class="st">"Profile residuals for 'JRSS-A'"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">'black'</span>, <span class="st">'tomato2'</span>), <span class="dt">guide =</span> <span class="st">'none'</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/jrssa-1.png" width="576"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(resids_jrssa) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(q_theo, residual, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> journal <span class="op">==</span><span class="st"> 'JRSS-A'</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggqqline</span>(resids_jrssa<span class="op">$</span>residual) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Normal quantiles'</span>,
       <span class="dt">y =</span> <span class="st">'Sample quantiles'</span>,
       <span class="dt">title =</span> <span class="st">"Profile residuals for 'JRSS-A'"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">'black'</span>, <span class="st">'tomato2'</span>), <span class="dt">guide =</span> <span class="st">'none'</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/jrssa-2.png" width="576"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">resids_tech  &lt;-<span class="st"> </span><span class="kw">data_frame</span>(<span class="dt">journal =</span> <span class="kw">rownames</span>(citations),
                           <span class="dt">fitted =</span> <span class="kw">drop</span>(<span class="kw"><a href="../reference/fitted_citations.html">fitted_citations</a></span>(<span class="st">'Tech'</span>, citations, clusters)),
                           <span class="dt">residual =</span> <span class="kw"><a href="../reference/profile_residuals.html">profile_residuals</a></span>(fitted, citations[, <span class="st">'Tech'</span>]),
                           <span class="dt">q_theo =</span> <span class="kw">qqnorm</span>(residual, <span class="dt">plot =</span> F)<span class="op">$</span>x)

<span class="kw">ggplot</span>(resids_tech) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(fitted, residual, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">colour =</span> <span class="st">'steelblue'</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">'loess'</span>, <span class="dt">colour =</span> <span class="st">'steelblue'</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> journal <span class="op">==</span><span class="st"> 'Tech'</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Predicted citation counts'</span>, <span class="dt">y =</span> <span class="st">'Residuals'</span>,
       <span class="dt">title =</span> <span class="st">"Profile residuals for 'Technometrics'"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">'black'</span>, <span class="st">'tomato2'</span>), <span class="dt">guide =</span> <span class="st">'none'</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/tech-1.png" width="576"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(resids_tech) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(q_theo, residual, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> journal <span class="op">==</span><span class="st"> 'Tech'</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggqqline</span>(resids_tech<span class="op">$</span>residual) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Normal quantiles'</span>,
       <span class="dt">y =</span> <span class="st">'Sample quantiles'</span>,
       <span class="dt">title =</span> <span class="st">"Profile residuals for 'Technometrics'"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">'black'</span>, <span class="st">'tomato2'</span>), <span class="dt">guide =</span> <span class="st">'none'</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/tech-2.png" width="576"></p>
<p>If we look back at the section <strong>Community residuals controlling for self-citation</strong> then it is clear that the extreme residuals exhibited by <em>JRSS-A</em> and <em>Technometrics</em> are effective nullified by controlling for excess self-citation.</p>
<p>Look at <em>JRSS-A</em> and <em>Technometrics</em>’ profile residuals when excessive self-citation is added to their respective models:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">resids_jrssa_test_self &lt;-<span class="st"> </span>models <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(from <span class="op">==</span><span class="st"> 'JRSS-A'</span> <span class="op">|</span><span class="st"> </span>from <span class="op">==</span><span class="st"> 'Tech'</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/gather">gather</a></span>(<span class="st">'model_type'</span>, <span class="st">'model'</span>, xs_selfcitations<span class="op">:</span>null_model) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span>
<span class="st">  </span>broom<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/augment">augment</a></span>(model, <span class="dt">type.residuals =</span> <span class="st">'pearson'</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(from, model_type) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">q_theo =</span> <span class="kw">qqnorm</span>(.resid, <span class="dt">plot=</span>F)<span class="op">$</span>x,
         <span class="dt">journal =</span> <span class="kw">rownames</span>(scrooge<span class="op">::</span>citations))

<span class="kw">ggplot</span>(resids_jrssa_test_self) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(<span class="kw">exp</span>(.fitted), .resid, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">colour =</span> <span class="st">'steelblue'</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="co">#geom_smooth(method = 'loess', colour = 'steelblue', se = FALSE) +</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> journal <span class="op">==</span><span class="st"> </span>from)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">'black'</span>, <span class="st">'tomato2'</span>), <span class="dt">guide =</span> <span class="st">'none'</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(model_type <span class="op">~</span><span class="st"> </span>from) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Predicted citation counts'</span>, <span class="dt">y =</span> <span class="st">'Residuals'</span>,
       <span class="dt">title =</span> <span class="st">"Profile residuals against fitted values for 'JRSS-A' and 'Technometrics'"</span>,
       <span class="dt">subtitle =</span> <span class="st">"With and without modelling for excess self-citation"</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/jrssa_test_self-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(resids_jrssa_test_self) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(q_theo, .resid, <span class="dt">label =</span> journal) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> journal <span class="op">==</span><span class="st"> </span>from)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">'black'</span>, <span class="st">'tomato2'</span>), <span class="dt">guide =</span> <span class="st">'none'</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(model_type <span class="op">~</span><span class="st"> </span>from) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">'Normal quantiles'</span>,
       <span class="dt">y =</span> <span class="st">'Sample quantiles'</span>,
       <span class="dt">title =</span> <span class="st">"QQ plots of profile residuals for 'JRSS-A' and 'Technometrics'"</span>,
       <span class="dt">subtitle =</span> <span class="st">"With and without modelling for excess self-citation"</span>)</code></pre></div>
<p><img src="residuals_files/figure-html/jrssa_test_self-2.png" width="672"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#citation-profiles">Citation profiles</a></li>
      <li><a href="#convex-combinations-of-community-profiles">Convex combinations of community profiles</a></li>
      <li><a href="#controlling-for-excessive-self-citation-behaviour">Controlling for excessive self-citation behaviour</a></li>
      <li><a href="#community-residuals">Community residuals</a></li>
      <li><a href="#community-residuals-controlling-for-self-citation">Community residuals controlling for self-citation</a></li>
      <li><a href="#tidy-profile-models">Tidy profile models</a></li>
      <li><a href="#further-investigations">Further investigations</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by David Selby.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
